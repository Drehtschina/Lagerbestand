<script>
    let products = JSON.parse(localStorage.getItem('products') || '[]');

    function saveProducts() {
        localStorage.setItem('products', JSON.stringify(products));
    }

    function updateTable() {
        const tbody = document.getElementById('product-table-body');
        tbody.innerHTML = '';
        products.forEach(product => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.name}</td>
                <td>${product.barcode}</td>
                <td>${product.stock}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function adjustStockByBarcode() {
        const barcodeInput = document.getElementById('barcode-input');
        const barcode = barcodeInput.value.trim().toLowerCase();  // Kleinbuchstaben + Trim

        console.log('Eingegebener Barcode:', barcode);
        console.log('Produkte im Lager:', products);

        const product = products.find(p => p.barcode.trim().toLowerCase() === barcode);
        if (product) {
            const amountStr = prompt(`Aktueller Bestand: ${product.stock}\nWie viel hinzuf端gen (+) oder entnehmen (-)?`);
            const amount = parseInt(amountStr);
            if (!isNaN(amount)) {
                product.stock += amount;
                saveProducts();
                updateTable();
                alert(`${product.name}: Neuer Bestand: ${product.stock}`);
            } else {
                alert("Ung端ltige Eingabe!");
            }
        } else {
            alert("Produkt nicht gefunden!");
        }

        barcodeInput.value = '';
        barcodeInput.focus();
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(products, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "lagerbestand.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData() {
        const fileInput = document.getElementById('import-file');
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedProducts = JSON.parse(event.target.result);
                if (Array.isArray(importedProducts)) {
                    products = importedProducts;
                    saveProducts();
                    updateTable();
                    alert("Daten erfolgreich importiert!");
                } else {
                    alert("Ung端ltiges Format!");
                }
            } catch (e) {
                alert("Fehler beim Importieren der Datei.");
            }
        };
        reader.readAsText(file);
    }

    function addNewProduct() {
        const name = prompt("Produktname:");
        const barcode = prompt("Barcode:").trim();
        const stockStr = prompt("Start-Bestand:");
        const stock = parseInt(stockStr);
        if (name && barcode && !isNaN(stock)) {
            products.push({ name, barcode, stock });
            saveProducts();
            updateTable();
        } else {
            alert("Ung端ltige Eingabe!");
        }
    }

    updateTable();
</script>

